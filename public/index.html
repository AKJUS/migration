<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://use.typekit.net/lly1mwm.css">
    <style>
      body {
        font-family: proxima-soft, sans-serif;
        padding: 0;
        margin: 0;
      }
      .flex {
        display: flex;
      }
      .items-center {
        align-items: center;
      }
      .justify-center {
        justify-content: center;
      }
      .center {
        text-align: center;
      }
      input[type=submit] {
        border-radius: 20px;
        background-color: #24ca7d;
        border: 1px solid transparent;
        color: white;
        font-size: 20px;
        padding: 10px 20px;
        font-family: proxima-soft, sans-serif;
        font-weight: bold;
        cursor: pointer;
      }
      input[type=submit]:disabled {
        opacity: 0.5;
      }
      textarea {
        font-family: monaco;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div class="flex items-center justify-center" style="margin-top: 10%">
      <div id="first">
        <div class="box center">
          <form onSubmit="return transform(event)">
            <div class="flex" style="width: 1000px; margin-bottom: 20px;">
              <textarea rows="30" style="width: 50%; margin-right: 20px" placeholder="ðŸ‘‹ Paste a config in here!" id="config"></textarea>
              <textarea rows="30" style="width: 50%" readonly="true" id="results" placeholder="ðŸ‘ˆ Paste config over there"></textarea>
            </div>
            <div>
              <input type="submit" value="Buildkite-ify!" id="button" />
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      function transform() {
        var button = document.getElementById("button");

        var configTextarea = document.getElementById("config");
        var formData = new FormData();
        formData.append("file", new Blob([configTextarea.value], { type: "text/plain" }));

        button.disabled = true;

        var resultsTextarea = document.getElementById("results");

        fetch("/", {
          method: "POST",
          credentials: 'same-origin',
          body: formData
        }).then(function(response) {
          button.disabled = false;
          if (!response.ok) {
            throw Error(response.statusText);
          }
          return response;
        }).then(function(response) {
          response.text().then(function(text) {
            resultsTextarea.value = text;
          });
        }).catch((function(error) {
          alert(error.message);
          resultsTextarea.value = '';
        }));

        return false;
      }

      function handleFormSubmit() {
        event.preventDefault();

        transform();
      }

      function handleFileSelect(evt) {
        evt.stopPropagation();
        evt.preventDefault();

        var file = evt.dataTransfer.files[0];

        if (file) {
          if (file.type == "application/x-yaml") {
            var reader = new FileReader();

            reader.onload = function(e) {
              document.getElementById("config").value = e.target.result;
              transform();
            };

            reader.readAsText(file);
          } else {
            alert("Only YAML files are supported - you uploaded a: " + file.type);
          }
        }
      }

      function handleDragOver(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
      }

      // Setup the dnd listeners.
      var dropZone = document.body;
      dropZone.addEventListener('dragover', handleDragOver, false);
      dropZone.addEventListener('drop', handleFileSelect, false);

    </script>
  </body>
</html>
